#!/bin/sh

set -e

echo '[SB2INIT] Setting up Corretto and multiverse apt repositories...'
wget -O- https://apt.corretto.aws/corretto.key | sudo apt-key add -
sudo add-apt-repository 'deb https://apt.corretto.aws stable main'
sudo add-apt-repository multiverse
sudo dpkg --add-architecture i386

echo '[SB2INIT] Running apt update...'
sudo apt -y update

echo '[SB2INIT] Running apt upgrade...'
sudo apt -y upgrade

echo '[SB2INIT]  corretto11...'
sudo apt -y install java-11-amazon-corretto-jdk

echo '[SB2INIT] Installing apt-provide AWS CLI version...'
sudo apt -y install awscli

echo '[SB2INIT] Installing steamcmd...'
sudo apt -y install lib32gcc1 steamcmd

echo '[SB2INIT] Setting up working directory...'
sudo mkdir /opt/serverbot2
sudo mkdir /opt/serverbot2/daemon
sudo mkdir /opt/serverbot2/script
sudo chown -R ubuntu:ubuntu /opt/serverbot2
cd /opt/serverbot2

echo '[SB2INIT] Setting up app daemon fetch script...'
cat > script/run_daemon.sh << "EOF"
BUCKET=$(aws ssm get-parameter --name '/common-config/deployed-artifacts-bucket' --output Parameter.Value)
aws s3 cp s3://$BUCKET/app-daemon.jar /opt/serverbot2/daemon/app-daemon.jar
java -jar /opt/serverbot2/daemon/app-daemon.jar
EOF
chmod 774 script/run_daemon.sh

echo '[SB2INIT] Setting up app daemon service unit...'
sudo tee /etc/systemd/system/serverbot2.service >/dev/null << "EOF"
[Unit]
Description=Run serverbot2 app daemon
Requires=Network.target
After=Network.target
[Service]
Type=simple
User=ubuntu
ExecStart=/opt/serverbot2/script/run_daemon.sh
[Install]
WantedBy=multi-user.target
EOF

echo '[SB2INIT] Starting app daemon service...'
sudo systemctl start serverbot2.service

echo '[SB2INIT] Init finished!'
