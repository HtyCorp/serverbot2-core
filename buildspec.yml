version: 0.2

env:
  variables:
    CDK_VERSION: "1.111.0"
    GRAAL_RELEASE: "vm-21.2.0"
    GRAAL_ARTIFACT: "graalvm-ce-java11-linux-amd64-21.2.0"
    JAVA_HOME: "/usr/local/lib/graalvm/vm-21.2.0"
    GRAAL_DOWNLOAD_PREFIX: "https://github.com/graalvm/graalvm-ce-builds/releases/download"

phases:
  install:
    commands:
      # Install NPM to 'global' local repo
      - "npm install -g aws-cdk@${CDK_VERSION}"
      # Skip step if Graal is already installed
      - |
        if [[ -f "${JAVA_HOME}" ]]; then
          echo "GraalVM ${GRAAL_ARTIFACT}" already installed" && exit 0;
        fi
      # Prepare JAVA_HOME directory and download/unzip GraalVM JDK
      - "mkdir -p \"${JAVA_HOME}\""
      - "curl -L \"${GRAAL_DOWNLOAD_PREFIX}/${GRAAL_RELEASE}/${GRAAL_ARTIFACT}.tar.gz\" | tar xzvC \"${JAVA_HOME}\""
      - "/usr/local/lib/graalvm/${GRAAL_RELEASE}/java -version"
      - "/usr/local/lib/graalvm/${GRAAL_RELEASE}/gu -v install native-image"
  build:
    commands:
      # Compile Java modules
      - "mvn clean install -Dmaven.test.skip=true"
      # Prep python dependencies (CDK will zip up the asset automatically)
      - "(cd web/url-shortener-frontend/edge-function && pip3 install -t . -r requirements.txt)"
      # Synthesize application/service CDK stacks for application deployment
      - "mkdir -p gen/cloud-assembly"
      - "(cd deployment/application-infrastructure/ && cdk synth -o ../../gen/cloud-assembly)"
      - "echo \"Generated $(cat gen/cloud-assembly/*.template.json | wc -l) template lines\""
  post_build:
    commands:
      - "echo \"Build completed at $(date)\""
artifacts:
  name: "cloud_assembly"
  base-directory: "gen/cloud-assembly"
  discard-paths: no
  files:
    - "**/*"
cache:
  paths:
    - '/root/.m2/**/*'
    - '/usr/local/lib/node_modules/aws-cdk/**/*'
    - '/usr/local/lib/graalvm/**/*'
